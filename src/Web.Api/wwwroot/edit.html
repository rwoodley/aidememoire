<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AideMemoire - Edit List</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 18px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            background: #121212;
            color: #e0e0e0;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }

        .hamburger {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            color: #e0e0e0;
            -webkit-tap-highlight-color: transparent;
        }

        .bucket-name {
            font-size: 1rem;
            color: #0a84ff;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        .bucket-name:hover {
            background: #2a2a2a;
        }

        .bucket-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #2a2a2a;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            min-width: 200px;
            z-index: 30;
            overflow: hidden;
        }

        .bucket-dropdown.open {
            display: block;
        }

        .bucket-dropdown-item {
            display: block;
            width: 100%;
            padding: 14px 20px;
            font-size: 1rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            color: #e0e0e0;
            -webkit-tap-highlight-color: transparent;
        }

        .bucket-dropdown-item:hover {
            background: #383838;
        }

        .bucket-dropdown-item.active {
            color: #0a84ff;
            font-weight: 600;
        }

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .menu-overlay.open {
            display: block;
        }

        .menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: #1e1e1e;
            z-index: 20;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
            transition: left 0.25s ease;
            padding: 20px 0;
        }

        .menu.open {
            left: 0;
        }

        .menu-header {
            font-size: 1.25rem;
            font-weight: 600;
            padding: 16px 24px;
            color: #e0e0e0;
            border-bottom: 1px solid #383838;
            margin-bottom: 8px;
        }

        .menu-item {
            display: block;
            width: 100%;
            padding: 16px 24px;
            font-size: 1.1rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            color: #e0e0e0;
            -webkit-tap-highlight-color: transparent;
        }

        .menu-item:hover {
            background: #2a2a2a;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
        }

        .edit-card {
            background: #1e1e1e;
            border-radius: 20px;
            padding: 32px 24px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .edit-card h2 {
            font-size: 1.5rem;
            color: #f0f0f0;
            margin-bottom: 24px;
            text-align: center;
        }

        .pair-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pair-table th {
            text-align: left;
            font-size: 0.85rem;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 8px 0;
            border-bottom: 1px solid #383838;
        }

        .pair-table td {
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2a;
            font-size: 1rem;
            color: #e0e0e0;
            vertical-align: top;
        }

        .pair-table tr:last-child td {
            border-bottom: none;
        }

        .pair-table .col-prompt {
            padding-right: 12px;
        }

        .pair-table .col-response {
            padding-left: 12px;
        }

        .pair-table .col-actions {
            width: 80px;
            white-space: nowrap;
            text-align: center;
            padding-left: 8px;
        }

        .btn-speaker {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #0a84ff;
            font-size: 1rem;
            line-height: 1;
            margin-left: 6px;
            -webkit-tap-highlight-color: transparent;
            vertical-align: middle;
        }

        .btn-delete-pair {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            color: #ff453a;
            font-size: 1.1rem;
            line-height: 1;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.2s;
        }

        .btn-delete-pair:hover {
            background: #3a2020;
        }

        .btn-edit-pair {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            color: #0a84ff;
            font-size: 1.1rem;
            line-height: 1;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.2s;
        }

        .btn-edit-pair:hover {
            background: #1a2a3a;
        }

        .edit-input {
            width: 100%;
            padding: 6px 8px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .edit-input:focus {
            outline: none;
            border-color: #0a84ff;
        }

        .btn-save-pair, .btn-cancel-pair {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            font-size: 1.1rem;
            line-height: 1;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.2s;
        }

        .btn-save-pair {
            color: #30d158;
        }

        .btn-save-pair:hover {
            background: #1a3a1a;
        }

        .btn-cancel-pair {
            color: #888;
        }

        .btn-cancel-pair:hover {
            background: #2a2a2a;
        }

        .pair-count {
            text-align: center;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            color: #777;
            font-size: 1.1rem;
            padding: 32px 0;
        }

        .loading-state {
            text-align: center;
            color: #777;
            font-size: 1.1rem;
            padding: 32px 0;
        }

        @media (max-width: 480px) {
            html {
                font-size: 16px;
            }

            .edit-card {
                padding: 24px 20px;
                border-radius: 16px;
            }
        }

        @media (min-width: 768px) {
            html {
                font-size: 20px;
            }

            .edit-card {
                padding: 48px 40px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <button class="hamburger" id="menuButton">&#9776;</button>
        <span class="bucket-name" id="bucketLabel">
            <span id="bucketText">Select List</span> &#9662;
            <div class="bucket-dropdown" id="bucketDropdown"></div>
        </span>
    </div>

    <div class="menu-overlay" id="menuOverlay"></div>
    <nav class="menu" id="menu">
        <div class="menu-header">AideMemoire</div>
        <button class="menu-item" id="drillMenuItem">Drill</button>
        <button class="menu-item" id="uploadMenuItem">Upload List</button>
        <button class="menu-item" id="manageMenuItem">Manage Lists</button>
    </nav>

    <div class="container">
        <div class="edit-card">
            <h2 id="heading">Edit List</h2>
            <div id="pairsContainer">
                <div class="loading-state">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const menuButton = document.getElementById('menuButton');
        const menu = document.getElementById('menu');
        const menuOverlay = document.getElementById('menuOverlay');
        const drillMenuItem = document.getElementById('drillMenuItem');
        const uploadMenuItem = document.getElementById('uploadMenuItem');
        const manageMenuItem = document.getElementById('manageMenuItem');
        const pairsContainer = document.getElementById('pairsContainer');
        const heading = document.getElementById('heading');
        const bucketLabel = document.getElementById('bucketLabel');
        const bucketText = document.getElementById('bucketText');
        const bucketDropdown = document.getElementById('bucketDropdown');

        function getBucketName() {
            const params = new URLSearchParams(window.location.search);
            return params.get('bucket');
        }

        function switchBucket(name) {
            window.location.href = `/edit.html?bucket=${encodeURIComponent(name)}`;
        }

        const bucketName = getBucketName();
        bucketText.textContent = bucketName || 'Select List';

        // Bucket dropdown
        bucketLabel.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (bucketDropdown.classList.contains('open')) {
                bucketDropdown.classList.remove('open');
                return;
            }

            bucketDropdown.innerHTML = '<div class="bucket-dropdown-item" style="color:#999">Loading...</div>';
            bucketDropdown.classList.add('open');

            try {
                const response = await fetch('/api/pairs/buckets');
                const buckets = await response.json();
                const currentBucket = getBucketName();

                bucketDropdown.innerHTML = '';
                buckets.forEach(name => {
                    const item = document.createElement('button');
                    item.className = 'bucket-dropdown-item' + (name === currentBucket ? ' active' : '');
                    item.textContent = name;
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        switchBucket(name);
                    });
                    bucketDropdown.appendChild(item);
                });
            } catch {
                bucketDropdown.innerHTML = '<div class="bucket-dropdown-item" style="color:#d32f2f">Failed to load</div>';
            }
        });

        document.addEventListener('click', () => {
            bucketDropdown.classList.remove('open');
        });

        // Menu open/close
        function openMenu() {
            menu.classList.add('open');
            menuOverlay.classList.add('open');
        }

        function closeMenu() {
            menu.classList.remove('open');
            menuOverlay.classList.remove('open');
        }

        menuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            openMenu();
        });

        menuOverlay.addEventListener('click', closeMenu);

        drillMenuItem.addEventListener('click', () => {
            closeMenu();
            window.location.href = bucketName ? `/?bucket=${encodeURIComponent(bucketName)}` : '/';
        });

        uploadMenuItem.addEventListener('click', () => {
            closeMenu();
            window.location.href = bucketName ? `/upload.html?bucket=${encodeURIComponent(bucketName)}` : '/upload.html';
        });

        manageMenuItem.addEventListener('click', () => {
            closeMenu();
            window.location.href = '/manage.html';
        });

        async function loadPairs() {
            if (!bucketName) {
                pairsContainer.innerHTML = '<div class="empty-state">No list specified.</div>';
                return;
            }

            heading.textContent = bucketName;

            try {
                const response = await fetch(`/api/pairs/buckets/${encodeURIComponent(bucketName)}`);
                if (!response.ok) {
                    pairsContainer.innerHTML = '<div class="empty-state" style="color:#ff453a">Failed to load pairs.</div>';
                    return;
                }

                const pairs = await response.json();

                if (pairs.length === 0) {
                    pairsContainer.innerHTML = '<div class="empty-state">This list is empty.</div>';
                    return;
                }

                const countDiv = document.createElement('div');
                countDiv.className = 'pair-count';
                countDiv.textContent = `${pairs.length} pair${pairs.length !== 1 ? 's' : ''}`;

                const table = document.createElement('table');
                table.className = 'pair-table';

                const thead = document.createElement('thead');
                thead.innerHTML = '<tr><th class="col-prompt">Prompt</th><th class="col-response">Response</th><th class="col-actions"></th></tr>';
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                pairs.forEach(pair => {
                    const tr = document.createElement('tr');

                    const tdPrompt = document.createElement('td');
                    tdPrompt.className = 'col-prompt';
                    tdPrompt.textContent = pair.prompt;

                    if (pair.audioId) {
                        const speakerBtn = document.createElement('button');
                        speakerBtn.className = 'btn-speaker';
                        speakerBtn.innerHTML = '&#128264;';
                        speakerBtn.title = 'Play audio';
                        speakerBtn.addEventListener('click', () => {
                            const audio = new Audio(`/api/pairs/buckets/${encodeURIComponent(bucketName)}/audio/${encodeURIComponent(pair.audioId)}`);
                            audio.play();
                        });
                        tdPrompt.appendChild(speakerBtn);
                    }

                    const tdResponse = document.createElement('td');
                    tdResponse.className = 'col-response';
                    tdResponse.textContent = pair.response;

                    const tdActions = document.createElement('td');
                    tdActions.className = 'col-actions';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn-edit-pair';
                    editBtn.innerHTML = '&#9998;';
                    editBtn.title = 'Edit pair';
                    editBtn.addEventListener('click', () => editPair(pair, tr));
                    tdActions.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-delete-pair';
                    deleteBtn.innerHTML = '&#128465;';
                    deleteBtn.title = 'Delete pair';
                    deleteBtn.addEventListener('click', () => deletePair(pair.prompt, tr));
                    tdActions.appendChild(deleteBtn);

                    tr.appendChild(tdPrompt);
                    tr.appendChild(tdResponse);
                    tr.appendChild(tdActions);
                    tbody.appendChild(tr);
                });

                table.appendChild(tbody);

                pairsContainer.innerHTML = '';
                pairsContainer.appendChild(countDiv);
                pairsContainer.appendChild(table);
            } catch {
                pairsContainer.innerHTML = '<div class="empty-state" style="color:#ff453a">Failed to load pairs.</div>';
            }
        }

        async function deletePair(prompt, rowElement) {
            try {
                const response = await fetch(`/api/pairs/buckets/${encodeURIComponent(bucketName)}/pairs`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                if (response.ok) {
                    rowElement.remove();
                    const countDiv = pairsContainer.querySelector('.pair-count');
                    const remaining = pairsContainer.querySelectorAll('tbody tr').length;
                    if (remaining === 0) {
                        pairsContainer.innerHTML = '<div class="empty-state">This list is empty.</div>';
                    } else if (countDiv) {
                        countDiv.textContent = `${remaining} pair${remaining !== 1 ? 's' : ''}`;
                    }
                }
            } catch {}
        }

        function editPair(pair, tr) {
            const tdPrompt = tr.children[0];
            const tdResponse = tr.children[1];
            const tdActions = tr.children[2];

            const origPromptHTML = tdPrompt.innerHTML;
            const origResponseHTML = tdResponse.innerHTML;
            const origActionsHTML = tdActions.innerHTML;

            const promptInput = document.createElement('input');
            promptInput.type = 'text';
            promptInput.className = 'edit-input';
            promptInput.value = pair.prompt;

            const responseInput = document.createElement('input');
            responseInput.type = 'text';
            responseInput.className = 'edit-input';
            responseInput.value = pair.response;

            tdPrompt.innerHTML = '';
            tdPrompt.appendChild(promptInput);

            tdResponse.innerHTML = '';
            tdResponse.appendChild(responseInput);

            tdActions.innerHTML = '';

            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn-save-pair';
            saveBtn.innerHTML = '&#10003;';
            saveBtn.title = 'Save';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn-cancel-pair';
            cancelBtn.innerHTML = '&#10005;';
            cancelBtn.title = 'Cancel';

            function restoreRow() {
                tdPrompt.innerHTML = origPromptHTML;
                tdResponse.innerHTML = origResponseHTML;
                tdActions.innerHTML = origActionsHTML;
            }

            cancelBtn.addEventListener('click', restoreRow);

            saveBtn.addEventListener('click', async () => {
                const newPrompt = promptInput.value.trim();
                const newResponse = responseInput.value.trim();
                if (!newPrompt || !newResponse) return;

                saveBtn.disabled = true;
                cancelBtn.disabled = true;

                try {
                    const response = await fetch(`/api/pairs/buckets/${encodeURIComponent(bucketName)}/pairs`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ oldPrompt: pair.prompt, newPrompt, newResponse })
                    });

                    if (response.ok) {
                        pair.prompt = newPrompt;
                        pair.response = newResponse;

                        tdPrompt.textContent = newPrompt;
                        if (pair.audioId) {
                            const speakerBtn = document.createElement('button');
                            speakerBtn.className = 'btn-speaker';
                            speakerBtn.innerHTML = '&#128264;';
                            speakerBtn.title = 'Play audio';
                            speakerBtn.addEventListener('click', () => {
                                const audio = new Audio(`/api/pairs/buckets/${encodeURIComponent(bucketName)}/audio/${encodeURIComponent(pair.audioId)}`);
                                audio.play();
                            });
                            tdPrompt.appendChild(speakerBtn);
                        }

                        tdResponse.textContent = newResponse;

                        tdActions.innerHTML = '';
                        const newEditBtn = document.createElement('button');
                        newEditBtn.className = 'btn-edit-pair';
                        newEditBtn.innerHTML = '&#9998;';
                        newEditBtn.title = 'Edit pair';
                        newEditBtn.addEventListener('click', () => editPair(pair, tr));
                        tdActions.appendChild(newEditBtn);

                        const newDeleteBtn = document.createElement('button');
                        newDeleteBtn.className = 'btn-delete-pair';
                        newDeleteBtn.innerHTML = '&#128465;';
                        newDeleteBtn.title = 'Delete pair';
                        newDeleteBtn.addEventListener('click', () => deletePair(pair.prompt, tr));
                        tdActions.appendChild(newDeleteBtn);
                    } else {
                        restoreRow();
                    }
                } catch {
                    restoreRow();
                }
            });

            tdActions.appendChild(saveBtn);
            tdActions.appendChild(cancelBtn);

            promptInput.focus();
        }

        loadPairs();
    </script>
</body>
</html>
